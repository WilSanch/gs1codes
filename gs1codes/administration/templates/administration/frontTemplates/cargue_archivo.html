{% extends 'administration/base.html' %}

{% block content %}  
{% if contexto.opc == 1 %}
<h6 class="center">Cargar archivo devolución de códigos</h6>
{% else %}
<h6 class="center">Inactivación masiva de prefijos</h6>
{% endif %}

<div class="row">
    <div class="col s12">
    <div class="card grey lighten-4">
        <div class="card-content orange-text text-darken-4">
        {% if contexto.opc == 1 %}
            <i class="material-icons prefix">info_outline</i> Recuerde: Para realizar este proceso debe convertir los archivos en Excel que fueron enviados por las empresas a archivos planos con extensión CSV. Para ver el resultado del proceso consulte el reporte: Resultado cargue migración
        {% else %}
            <i class="material-icons prefix">info_outline</i> Por medio de este proceso usted llevará a cabo la suspensión del derecho al uso de prefijos de las empresas registradas en el archivo. Para ver el resultado del proceso, de clic en el archivo cuyo reporte de resultados desea ver. Esto abrirá el resultado de inactivación masiva de prefijos.
        {% endif %}
        </div>
    </div>
    </div>
</div>
{% if contexto.opc == 1 %}
<form id="cargueArchivo" action="/codes/cargue_archivo/1/" method="post" enctype="multipart/form-data">
{% else %}
<form id="cargueArchivo" action="/codes/cargue_archivo/2/" method="post" enctype="multipart/form-data">
{% endif %}
    {% csrf_token %}
    <div class="file-field input-field">
        <div class="btn-small grey lighten-1">
            <span>Seleccionar Archivo</span>
            <input type="file" name="excel_file" required="required">
        </div>
        <div class="file-path-wrapper">
            <input class="file-path validate" type="text">
        </div>
    </div>
    {% if contexto.opc == 1 %}
    <a href="{{ MEDIA_URL }}/codes/media/Plantilla de devolucion de codigos.xlsx" download>
    {% else %}
    <a href="{{ MEDIA_URL }}/codes/media/Plantilla de inactivación masiva de prefijos.xlsx" download>
    {% endif %}
    
    <button type="button" class="btn btn-small waves-effect waves-light indigo" id="btnDownload">Descargar Plantilla
        <i class="tiny material-icons right">file_download</i>
    </button>
    </a>
    <button type="submit" class="btn btn-small waves-effect waves-light Orangelogyca">Cargar Archivo
        <i class="tiny material-icons right">file_upload</i>
    </button>
</form>    
<br><br>
<h6 class="center">Archivos en el Blob Azure</h6>
<input type="text" id="filter_blob" placeholder="Buscar...">
<table class="table stripped"  style="white-space: nowrap;" id="tbl_blob_table">  
    <thead>
        <tr>
            <th>Nombre</th>
            <th>Fecha</th>
        </tr>
    </thead>
    <tbody >
    {% for row in contexto.excel_data %}
    <tr>
        <td>{{row.nombre}}</td>
        <td>{{row.fecha_formato}}</td>
    </tr>
    {% endfor %}
    </tbody>
</table>

{% if contexto.error_list != None %}
<br><br>
<h6 class="center">Lista de errores</h6>
<input type="text" id="filter_error" placeholder="Buscar..."> 
<table class="table stripped"  style="white-space: nowrap;" id="tbl_error_table">  
    <thead>
        <tr>
            <th># Registro</th>
            <th>Mensaje Respuesta</th>
        </tr>
    </thead>
    <tbody >
    {% for row in contexto.error_list %}
    <tr>
        <td style="text-align:center;">{{row.IdRegistro}}</td>
        <td>{{row.MsgError}}</td>
    </tr>
    {% endfor %}
    </tbody>
</table>
{% endif %}

<input id="error" type="hidden" value="{{ contexto.Error }}">

{% endblock %}

{% block JsPage%}
<script>
    var msj = $('#error').val();
    if(msj.length > 0)
    {
        M.toast({ html: msj, classes: 'rounded Orangelogyca' })
    }

    $(document).ready(function(){
        var obj_tbl = $('#tbl_blob_table').DataTable({
            dom: 'B<"clear">rtip',
            pageLength: 4,
            buttons: {
                name: 'primary',
                buttons: ['excel']
            },
            orderCellsTop: true
        });

        $('#filter_blob').keyup(function(){
            obj_tbl.search($(this).val()).draw() ;
        })

        var obj_tbl = $('#tbl_error_table').DataTable({
            dom: 'B<"clear">rtip',
            pageLength: 10,
            buttons: {
                name: 'primary',
                buttons: ['excel']
            },
            orderCellsTop: true
        });

        $('#filter_error').keyup(function(){
            obj_tbl.search($(this).val()).draw() ;
        })
    });
    
</script>
{% endblock%}